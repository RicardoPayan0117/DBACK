<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Solicita nuestro servicio de grúas 24/7. Asistencia rápida y profesional para todo tipo de vehículos.">
    <title>Solicitar Servicio de Grúa | Grúas DBACK</title>
    <link rel="stylesheet" href=".\CSS\Solicitud_ARCO.CSS">
    <style>
        .location-input-container {
            display: flex;
            align-items: center;
        }

        .location-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            margin-left: 5px;
        }

        .location-button img {
            width: 24px;
            height: 24px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <!-- Parte izquierda: Logo y nombre -->
            <a href="index.html" class="navbar-brand">
                <img src="Elementos\LogoDBACK.png" alt="Logo DBACK">
                <h1>Grúas DBACK</h1>
            </a>
            
            <!-- Parte derecha: Enlaces y botón de llamada -->
            <div class="nav-links">
                <a href="index.html" class="cta-button">inicio</a>
                <a href="tel:+526688253351" class="cta-button accent">Llamar ahora</a>
            </div>
        </div>
    </nav>   

    <section class="formulario">
        <h2>Solicitar Servicio de Grúa</h2>
        <p class="form-description">Complete el formulario y nos pondremos en contacto lo antes posible.</p>
        <form action="procesar_formulario.php" method="post" id="servicioForm" onsubmit="return validarYEnviarFormulario(event)">
            <!-- Información de contacto -->
            <div class="form-group">
                <label for="nombre">Nombre completo:</label>
                <input type="text" id="nombre" name="nombre" required 
                       pattern="[A-Za-záéíóúÁÉÍÓÚñÑ\s]{3,50}"
                       placeholder="Ej: Juan Pérez"
                       title="Ingrese un nombre válido (solo letras y espacios, mínimo 3 caracteres)">
            </div>

            <div class="form-group">
                <label for="telefono">Teléfono de contacto:</label>
                <input type="tel" id="telefono" name="telefono" required 
                       pattern="(\d{10}|\d{3}-\d{3}-\d{4})"
                       placeholder="Ej: 6681234567 o 668-123-4567"
                       title="Formato requerido: XXXXXXXXXX o XXX-XXX-XXXX">
            </div>

            <div class="form-group">
                <label for="email">Correo electrónico:</label>
                <input type="email" id="email" name="email" 
                       pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                       placeholder="Ej: juan@ejemplo.com"
                       title="Ingrese un correo electrónico válido">
            </div>

            <div class="form-group">
                <label for="ubicacion">Ubicación actual:</label>
                <div class="location-input-container">
                    <input type="text" id="ubicacion" name="ubicacion" required 
                           minlength="5"
                           placeholder="Dirección o punto de referencia" 
                           list="ubicaciones"
                           title="Ingrese una ubicación válida (mínimo 5 caracteres)">
                    <button type="button" id="obtenerUbicacion" class="location-button">
                        <img src="https://cdn-icons-png.flaticon.com/512/535/535137.png" alt="Obtener ubicación" title="Obtener mi ubicación actual">
                    </button>
                </div>
                <datalist id="ubicaciones"></datalist>
            </div>

            <!-- Información del vehículo -->
            <div class="form-group">
                <label for="vehiculo">Tipo de vehículo:</label>
                <select id="vehiculo" name="vehiculo" required>
                    <option value="">Seleccione una opción</option>
                    <option value="automovil">Automóvil</option>
                    <option value="camioneta">Camioneta</option>
                    <option value="motocicleta">Motocicleta</option>
                    <option value="camion">Camión</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="marca">Marca del vehículo:</label>
                <input type="text" id="marca" name="marca" required
                       minlength="2"
                       placeholder="Ej: Toyota, Ford, Nissan">
            </div>
            
            <div class="form-group">
                <label for="modelo">Modelo del vehículo:</label>
                <input type="text" id="modelo" name="modelo" required
                       minlength="2"
                       placeholder="Ej: Corolla, F-150, Sentra">
            </div>

            <div class="form-group">
                <label for="foto">Foto del vehículo (opcional):</label>
                <input type="file" id="foto" name="foto" accept="image/jpeg, image/png">
                <p><small>Formatos aceptados: JPG, PNG. Tamaño máximo: 5MB</small></p>
            </div>

            <!-- Información del servicio -->
            <div class="form-group">
                <label for="tipo_servicio">Tipo de Servicio:</label>
                <select id="tipo_servicio" name="tipo_servicio" required>
                    <option value="">Seleccione una opción</option>
                    <option value="remolque">Remolque</option>
                    <option value="bateria">Cambio de batería</option>
                    <option value="gasolina">Suministro de gasolina</option>
                    <option value="llanta">Cambio de llanta</option>
                    <option value="arranque">Servicio de arranque</option>
                    <option value="otro">Otro servicio</option>
                </select>
            </div>

            <div class="form-group">
                <label for="descripcion">Descripción del problema:</label>
                <textarea id="descripcion" name="descripcion" rows="4" 
                          minlength="10" maxlength="500"
                          placeholder="Describa brevemente la situación"
                          title="La descripción debe tener entre 10 y 500 caracteres"></textarea>
            </div>

            <div class="form-group">
                <label for="urgencia">Nivel de urgencia:</label>
                <select id="urgencia" name="urgencia" required>
                    <option value="normal">Normal</option>
                    <option value="urgente">Urgente</option>
                    <option value="emergencia">Emergencia</option>
                </select>
            </div>
            
            <!-- Información de cálculo de distancia y costos -->
            <div class="info-container">
                <div class="form-group">
                    <label for="distancia">Distancia estimada:</label>
                    <input type="text" id="distancia" name="distancia" readonly 
                           placeholder="Calculando..." value="">
                </div>
                
                <div class="form-group">
                    <label for="costo">Costo estimado:</label>
                    <input type="text" id="costo" name="costo" readonly 
                           placeholder="Calculando..." value="">
                </div>
            </div>
            
            <!-- Sección de resumen para pago -->
            <div class="summary-section">
                <h3>Resumen de Solicitud</h3>
                <div class="summary-row">
                    <span>Cliente:</span>
                    <span id="display-nombre">(Por completar)</span>
                </div>
                <div class="summary-row">
                    <span>Correo:</span>
                    <span id="display-email">(Por completar)</span>
                </div>
                <div class="summary-row">
                    <span>Costo total estimado:</span>
                    <span id="display-costo">$0.00 MXN</span>
                </div>
                <div class="summary-row">
                    <span>Depósito requerido (20%):</span>
                    <span id="display-deposito">$0.00 MXN</span>
                </div>
                <div class="summary-row">
                    <span>Pago restante:</span>
                    <span id="display-restante">$0.00 MXN</span>
                </div>
                
            </div>
               <!-- Información de pago con PayPal -->
               <div class="payment-info">
                <h3>Opciones de Pago</h3>
                <p>Para asegurar su servicio, puede realizar un depósito del 20% del costo total estimado.</p>
                <p>El monto restante se pagará al finalizar el servicio.</p>
                
                <!-- Contenedor del botón de PayPal -->
                <div id="paypal-button-container">
                    <button id="custom-paypal-button" class="paypal-button" onclick="initiatePayPalPayment()">
                        <img src="https://www.paypalobjects.com/webstatic/mktg/logo/pp_cc_mark_37x23.jpg" alt="PayPal Logo">
                        Pagar con PayPal
                    </button>
                </div>
                
                <input type="hidden" id="paypal_order_id" name="paypal_order_id">
                <input type="hidden" id="paypal_status" name="paypal_status">
                <input type="hidden" id="paypal_email" name="paypal_email">
                <input type="hidden" id="paypal_name" name="paypal_name">
            </div>

            <!-- Checkbox para confirmar consentimiento -->
            <div id="privacy-container" class="privacy-checkbox-container">
                <input type="checkbox" id="consentimiento" name="consentimiento" required>
                <label for="consentimiento"><span class="privacy-text">He leído y acepto la <span class="privacy-link" id="openConsentModal">política de privacidad</span></span></label>
            </div>
            
         
            <!-- Botones de acción -->
            <div class="action-buttons">
               
                <button type="submit" class="cta-button" id="submit-button">Enviar Solicitud</button>
            </div>
        </form>
        
        <p class="emergency-note">Para emergencias inmediatas, llame al <a href="tel:+526688253351" class="emergency-phone">668-825-3351</a></p>
    </section>

    <!-- Modal de política de privacidad -->
    <div id="consentModal" class="modal-overlay">
        <div class="modal-container">
            <button class="close-modal" id="closeModal">&times;</button>
            
            <div class="header-decoration">
                <h1>Consentimiento de Datos Personales</h1>
            </div>
            
            <p>Por este medio, expreso y otorgo mi consentimiento a Grúas DBACK en la recopilación, almacenamiento y uso de mis datos personales, con los fines relacionados con la prestación y uso de los servicios prestados por Grúas DBACK, tales como solicitudes de asistencia, el seguimiento de vehículos atendidos y la emisión de recibos o facturas de pago correspondiente.</p>
            
            <h2>Datos personales recopilados</h2>
            <ul>
                <li>Nombre completo</li>
                <li>Domicilio</li>
                <li>Número de teléfono</li>
                <li>Correo electrónico</li>
                <li>Datos del vehículo</li>
                <li>Información de la solicitud de servicio</li>
                <li>Ubicación del servicio</li>
                <li>Fecha y hora de la solicitud</li>
            </ul>
            
            <h2>Tratamiento de datos</h2>
            <p>La información recopilada será tratada en estricto apego a lo establecido por la Ley Federal de Protección de Datos Personales en Posesión de los Particulares y será utilizada exclusivamente para los fines mencionados.</p>
            
            <h2>Medios de contacto de Grúas DBACK para ejercer mis derechos ARCO</h2>
            <p>Para más información sobre los derechos ARCO, visita: <a href="https://www.gob.mx/cms/uploads/attachment/file/428335/DDP_Gu_a_derechos_ARCO_13Dic18.pdf" target="_blank">Guía Derechos ARCO</a></p>
            <p>Correo electrónico: <a href="mailto:protecciondedatos@gruasdback.com">protecciondedatos@gruasdback.com</a></p>
            <p>Teléfono: <a href="tel:6688132905">668 813 2905</a></p>
            <p>Dirección: Manuel Castro Elizalde 895 SUR, Luis Donaldo Colosio, Colón, 81233 Los Mochis, Sin.</p>
            
            <h2>Consentimiento</h2>
            <p>Al hacer clic en "Aceptar", confirmo que he leído y comprendido los términos de esta autorización y que otorgo mi consentimiento para el tratamiento de mis datos personales a Grúas DBACK.</p>
            
            <div class="button-container">
                <a href="#" class="button" id="acceptConsent">Aceptar</a>
                <a href="#" class="button button-reject" id="rejectConsent">Rechazar</a>
            </div>
            
            <div class="footer-decoration">
                <p>Grúas DBACK - Documento de Consentimiento de Datos Personales</p>
            </div>
        </div>
    </div>
    
    <!-- Modal de notificación de rechazo -->
    <div id="rejectModal" class="modal-overlay">
        <div class="small-modal-container">
            <h2>Consentimiento Requerido</h2>
            <p>Debe aceptar la política de privacidad para utilizar nuestros servicios. 
                No podemos procesar su solicitud sin su consentimiento para el tratamiento de datos personales.</p>
            <button class="notification-button" id="closeRejectModal">Entendido</button>
        </div>
    </div>
    
    <!-- Modal de éxito al enviar -->
    <div id="successModal" class="success-modal-overlay">
        <div class="success-modal-container">
            <h2>¡Solicitud Enviada!</h2>
            <p>Su solicitud se ha enviado con éxito.</p>
            <p>Nos pondremos en contacto con usted a la brevedad posible.</p>
            <button class="success-button" id="closeSuccessModal">Aceptar</button>
        </div>
    </div>

    <script>
        // Variables globales
        let costoTotalServicio = 0;
        const ubicacionEmpresa = "21.019418,-89.617202"; // Coordenadas de la empresa
        
        // Función para obtener la ubicación actual
        function obtenerUbicacionActual() {
            const ubicacionInput = document.getElementById('ubicacion');
            
            if (!navigator.geolocation) {
                alert("La geolocalización no es soportada por tu navegador");
                return;
            }
            
            ubicacionInput.placeholder = "Obteniendo ubicación...";
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const coordenadas = `${lat},${lng}`;
                    
                    // Simulamos la obtención de dirección (en implementación real usarías Google Maps API)
                    ubicacionInput.value = coordenadas;
                    calcularDistancia(coordenadas);
                },
                function(error) {
                    console.error("Error al obtener la ubicación:", error);
                    ubicacionInput.placeholder = "Dirección o punto de referencia";
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            alert("Permiso denegado para acceder a la ubicación");
                            break;
                        case error.POSITION_UNAVAILABLE:
                            alert("La información de ubicación no está disponible");
                            break;
                        case error.TIMEOUT:
                            alert("Tiempo de espera agotado al obtener la ubicación");
                            break;
                        default:
                            alert("Error desconocido al obtener la ubicación");
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Función para actualizar la información del usuario
        function actualizarInfoUsuario() {
            const nombre = document.getElementById('nombre').value || '(Por completar)';
            const email = document.getElementById('email').value || '(No especificado)';
            
            document.getElementById('display-nombre').textContent = nombre;
            document.getElementById('display-email').textContent = email;
            
            // Actualizar campos ocultos para el backend
            document.getElementById('paypal_name').value = nombre;
            document.getElementById('paypal_email').value = email;
        }

        // Función para actualizar la información de pago
        function actualizarInfoPago() {
            const deposito = (costoTotalServicio * 0.2).toFixed(2);
            const restante = (costoTotalServicio * 0.8).toFixed(2);
            
            document.getElementById('display-costo').textContent = `${costoTotalServicio.toFixed(2)} MXN`;
            document.getElementById('display-deposito').textContent = `${deposito} MXN`;
            document.getElementById('display-restante').textContent = `${restante} MXN`;
        }

        // Función para calcular la distancia (simulada)
        function calcularDistancia(destino) {
            // En una implementación real, usarías la API de Google Maps
            // Esta es una simulación para el ejemplo
            setTimeout(() => {
                const distanciaKm = Math.random() * 50 + 5; // Entre 5 y 55 km
                const costoPorKilometro = 80; // 80 pesos por kilómetro
                costoTotalServicio = distanciaKm * costoPorKilometro;
                
                // Mostrar la distancia y el costo
                document.getElementById('distancia').value = `${distanciaKm.toFixed(2)} km`;
                document.getElementById('costo').value = `${costoTotalServicio.toFixed(2)} MXN`;
                
                // Actualizar la sección de pago
                actualizarInfoPago();
                
                // También actualizamos la información del usuario
                actualizarInfoUsuario();
            }, 1000);
        }

        // Script para controlar la apertura y cierre de los modales
        document.addEventListener('DOMContentLoaded', function() {
            const consentModal = document.getElementById('consentModal');
            const rejectModal = document.getElementById('rejectModal');
            const successModal = document.getElementById('successModal');
            const openConsentModal = document.getElementById('openConsentModal');
            const closeModal = document.getElementById('closeModal');
            const acceptConsent = document.getElementById('acceptConsent');
            const rejectConsent = document.getElementById('rejectConsent');
            const closeRejectModal = document.getElementById('closeRejectModal');
            const closeSuccessModal = document.getElementById('closeSuccessModal');
            const consentCheckbox = document.getElementById('consentimiento');
            
            // Evento para abrir modal de consentimiento
            openConsentModal.addEventListener('click', function(e) {
                e.preventDefault();
                consentModal.style.display = 'flex';
            });
            
            // Evento para cerrar el modal de consentimiento
            closeModal.addEventListener('click', function() {
                consentModal.style.display = 'none';
            });
            
            // Evento para aceptar el consentimiento
            acceptConsent.addEventListener('click', function(e) {
                e.preventDefault();
                consentCheckbox.checked = true;
                consentModal.style.display = 'none';
            });
            
            // Evento para rechazar el consentimiento
            rejectConsent.addEventListener('click', function(e) {
                e.preventDefault();
                consentCheckbox.checked = false;
                consentModal.style.display = 'none';
                rejectModal.style.display = 'flex';
            });
            
            // Evento para cerrar el modal de rechazo
            closeRejectModal.addEventListener('click', function() {
                rejectModal.style.display = 'none';
            });
            
            // Evento para cerrar el modal de éxito
            closeSuccessModal.addEventListener('click', function() {
                successModal.style.display = 'none';
                window.location.href = 'index.html'; // Redirigir a la página principal
            });
            
            // Eventos para actualizar la información del usuario
            const formInputs = document.querySelectorAll('#nombre, #email, #ubicacion');
            formInputs.forEach(input => {
                input.addEventListener('input', function() {
                    actualizarInfoUsuario();
                    
                    // Si es el campo de ubicación, calcular distancia
                    if (this.id === 'ubicacion' && this.value.length > 5) {
                        calcularDistancia(this.value);
                    }
                });
            });
            
            // Añadir evento al botón de obtener ubicación
            document.getElementById('obtenerUbicacion').addEventListener('click', obtenerUbicacionActual);
            
            // Inicializar cálculos
            calcularDistancia(""); // Cálculo inicial simulado
        });
        
        // Función para manejar el pago con PayPal
        function initiatePayPalPayment() {
            // En una implementación real, se comunicaría con la API de PayPal
            // Esta es una simulación para el ejemplo
            if (costoTotalServicio <= 0) {
                alert("Error: No se ha podido calcular el costo del servicio.");
                return;
            }
            
            const deposito = (costoTotalServicio * 0.2).toFixed(2);
            
            // Simulación de un ID de pedido de PayPal
            const fakeOrderId = 'PAYPAL-' + Math.random().toString(36).substring(2, 15);
            
            // Actualizar campos ocultos
            document.getElementById('paypal_order_id').value = fakeOrderId;
            document.getElementById('paypal_status').value = 'COMPLETED';
            
            alert(`Simulación de pago con PayPal completada.\nMonto: $${deposito} MXN\nOrder ID: ${fakeOrderId}`);
            
            // En un escenario real, esto redirigiría al usuario a PayPal
            // y luego volvería con un callback
        }
        
        // Función para validar y enviar el formulario
        function validarYEnviarFormulario(event) {
            event.preventDefault();
            
            // Obtener elementos del formulario
            const form = document.getElementById('servicioForm');
            const consentCheckbox = document.getElementById('consentimiento');
            const successModal = document.getElementById('successModal');
            
            // Verificar si el checkbox de consentimiento está marcado
            if (!consentCheckbox.checked) {
                const rejectModal = document.getElementById('rejectModal');
                rejectModal.style.display = 'flex';
                return false;
            }
            
            // Validar campos requeridos
            let formValido = true;
            const camposRequeridos = form.querySelectorAll('[required]');
            
            camposRequeridos.forEach(campo => {
                if (!campo.value.trim()) {
                    campo.classList.add('invalid');
                    formValido = false;
                } else {
                    campo.classList.remove('invalid');
                }
            });
            
            if (!formValido) {
                alert("Por favor, complete todos los campos requeridos.");
                return false;
            }
            
            // En una implementación real, aquí se enviarían los datos al servidor
            // mediante una petición AJAX o Fetch
            
            // Simulamos una respuesta exitosa
            setTimeout(() => {
                successModal.style.display = 'flex';
                
                // Limpiar formulario
                form.reset();
                costoTotalServicio = 0;
                actualizarInfoPago();
                actualizarInfoUsuario();
            }, 1000);
            
            return false; // Prevenir envío del formulario
        }
        
        // Añadir funcionalidad para la carga de fotos
        document.getElementById('foto').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Verificar tamaño del archivo (máximo 5MB)
            const maxSize = 5 * 1024 * 1024; // 5MB en bytes
            if (file.size > maxSize) {
                alert('El archivo es demasiado grande. El tamaño máximo permitido es 5MB.');
                this.value = ''; // Limpiar el input
                return;
            }
            
            // Verificar formato del archivo
            const validTypes = ['image/jpeg', 'image/png'];
            if (!validTypes.includes(file.type)) {
                alert('Formato de archivo no válido. Solo se permiten imágenes JPG y PNG.');
                this.value = ''; // Limpiar el input
                return;
            }
        });
    </script>
</body>
</html>