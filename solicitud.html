<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Solicita nuestro servicio de grúas 24/7. Asistencia rápida y profesional para todo tipo de vehículos.">
    <title>Solicitar Servicio de Grúa | Grúas DBACK</title>
    <link rel="stylesheet" href=".\CSS\Solicitud_ARCO.CSS">
    <style>
        /* Estilos generales */
        .location-section {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: #f9f9f9;
        }
        
        .location-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .location-input-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .location-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            margin-left: 5px;
        }

        .location-button img {
            width: 24px;
            height: 24px;
        }

        /* Estilos para PayPal */
        .paypal-success {
            border: 1px solid #28a745;
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .paypal-error {
            border: 1px solid #dc3545;
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .payment-info-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .payment-methods {
            margin: 20px 0;
        }

        .payment-method {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-method:hover {
            background-color: #f0f0f0;
        }

        .payment-method.selected {
            border-color: #007bff;
            background-color: #e6f2ff;
        }

        .payment-method input[type="radio"] {
            margin-right: 10px;
        }

        .payment-method-icon {
            width: 32px;
            height: 32px;
            margin-right: 10px;
        }

        .payment-method-details {
            flex-grow: 1;
        }

        .payment-method-title {
            font-weight: bold;
            font-size: 16px;
            margin: 0 0 5px 0;
        }

        .payment-method-description {
            font-size: 14px;
            color: #666;
            margin: 0;
        }

        .payment-container {
            display: none;
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .payment-container.active {
            display: block;
        }

        #custom-paypal-button {
            background: #FFC439;
            color: #111;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        #custom-paypal-button:hover {
            background: #F0B72B;
        }

        #custom-paypal-button img {
            height: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <a href="index.html" class="navbar-brand">
                <img src="Elementos\LogoDBACK.png" alt="Logo DBACK">
                <h1>Grúas DBACK</h1>
            </a>
            
            <div class="nav-links">
                <a href="index.html" class="cta-button">inicio</a>
                <a href="tel:+526688253351" class="cta-button accent">Llamar ahora</a>
            </div>
        </div>
    </nav>   

    <section class="formulario">
        <h2>Solicitar Servicio de Grúa</h2>
        <p class="form-description">Complete el formulario y nos pondremos en contacto lo antes posible.</p>
        <form action="procesar_servicio.php" method="post" id="servicioForm" onsubmit="return validarYEnviarFormulario(event)">
            <!-- Información de contacto -->
            <div class="form-group">
                <label for="nombre">Nombre completo:</label>
                <input type="text" id="nombre" name="nombre" required 
                       pattern="[A-Za-záéíóúÁÉÍÓÚñÑ\s]{3,50}"
                       placeholder="Ej: Juan Pérez"
                       title="Ingrese un nombre válido (solo letras y espacios, mínimo 3 caracteres)">
            </div>

            <div class="form-group">
                <label for="telefono">Teléfono de contacto:</label>
                <input type="tel" id="telefono" name="telefono" required 
                       pattern="(\d{10}|\d{3}-\d{3}-\d{4})"
                       placeholder="Ej: 6681234567 o 668-123-4567"
                       title="Formato requerido: XXXXXXXXXX o XXX-XXX-XXXX">
            </div>

            <div class="form-group">
                <label for="email">Correo electrónico:</label>
                <input type="email" id="email" name="email" 
                       pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                       placeholder="Ej: juan@ejemplo.com"
                       title="Ingrese un correo electrónico válido">
            </div>

            <!-- Sección de ubicaciones -->
            <div class="location-section">
                <h3>Ubicación de Recogida</h3>
                <div class="form-group">
                    <label for="ubicacion_origen">Ubicación actual del vehículo:</label>
                    <div class="location-input-container">
                        <input type="text" id="ubicacion_origen" name="ubicacion_origen" required 
                               minlength="5"
                               placeholder="Dirección o punto de referencia" 
                               list="ubicaciones_origen"
                               title="Ingrese una ubicación válida (mínimo 5 caracteres)">
                        <button type="button" id="obtenerUbicacionOrigen" class="location-button">
                            <img src="https://cdn-icons-png.flaticon.com/512/535/535137.png" alt="Obtener ubicación" title="Obtener mi ubicación actual">
                        </button>
                    </div>
                    <datalist id="ubicaciones_origen"></datalist>
                </div>
            </div>
            
            <div class="location-section">
                <h3>Ubicación de Entrega</h3>
                <div class="form-group">
                    <label for="ubicacion_destino">¿A dónde necesita llevar el vehículo?</label>
                    <div class="location-input-container">
                        <input type="text" id="ubicacion_destino" name="ubicacion_destino" required 
                               minlength="5"
                               placeholder="Dirección o punto de referencia" 
                               list="ubicaciones_destino"
                               title="Ingrese una ubicación válida (mínimo 5 caracteres)">
                        <button type="button" id="obtenerUbicacionDestino" class="location-button">
                            <img src="https://cdn-icons-png.flaticon.com/512/535/535137.png" alt="Obtener ubicación" title="Obtener mi ubicación actual">
                        </button>
                    </div>
                    <datalist id="ubicaciones_destino"></datalist>
                </div>
            </div>

            <!-- Información del vehículo -->
            <div class="form-group">
                <label for="vehiculo">Tipo de vehículo:</label>
                <select id="vehiculo" name="vehiculo" required>
                    <option value="">Seleccione una opción</option>
                    <option value="automovil">Automóvil</option>
                    <option value="camioneta">Camioneta</option>
                    <option value="motocicleta">Motocicleta</option>
                    <option value="camion">Camión</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="marca">Marca del vehículo:</label>
                <input type="text" id="marca" name="marca" required
                       minlength="2"
                       placeholder="Ej: Toyota, Ford, Nissan">
            </div>
            
            <div class="form-group">
                <label for="modelo">Modelo del vehículo:</label>
                <input type="text" id="modelo" name="modelo" required
                       minlength="2"
                       placeholder="Ej: Corolla, F-150, Sentra">
            </div>

            <div class="form-group">
                <label for="foto">Foto del vehículo (opcional):</label>
                <input type="file" id="foto" name="foto" accept="image/jpeg, image/png">
                <p><small>Formatos aceptados: JPG, PNG. Tamaño máximo: 5MB</small></p>
            </div>

            <!-- Información del servicio -->
            <div class="form-group">
                <label for="tipo_servicio">Tipo de Servicio:</label>
                <select id="tipo_servicio" name="tipo_servicio" required>
                    <option value="">Seleccione una opción</option>
                    <option value="remolque">Remolque</option>
                    <option value="bateria">Cambio de batería</option>
                    <option value="gasolina">Suministro de gasolina</option>
                    <option value="llanta">Cambio de llanta</option>
                    <option value="arranque">Servicio de arranque</option>
                    <option value="otro">Otro servicio</option>
                </select>
            </div>

            <div class="form-group">
                <label for="descripcion">Descripción del problema:</label>
                <textarea id="descripcion" name="descripcion" rows="4" 
                          minlength="10" maxlength="500"
                          placeholder="Describa brevemente la situación"
                          title="La descripción debe tener entre 10 y 500 caracteres"></textarea>
            </div>

            <div class="form-group">
                <label for="urgencia">Nivel de urgencia:</label>
                <select id="urgencia" name="urgencia" required>
                    <option value="normal">Normal</option>
                    <option value="urgente">Urgente</option>
                    <option value="emergencia">Emergencia</option>
                </select>
            </div>
            
            <!-- Información de cálculo de distancia y costos -->
            <div class="info-container">
                <div class="form-group">
                    <label for="distancia">Distancia estimada:</label>
                    <input type="text" id="distancia" name="distancia" readonly 
                           placeholder="Calculando..." value="">
                </div>
                
                <div class="form-group">
                    <label for="costo">Costo estimado:</label>
                    <input type="text" id="costo" name="costo" readonly 
                           placeholder="Calculando..." value="">
                </div>
            </div>
            
            <!-- Sección de resumen para pago -->
            <div class="summary-section">
                <h3>Resumen de Solicitud</h3>
                <div class="summary-row">
                    <span>Cliente:</span>
                    <span id="display-nombre">(Por completar)</span>
                </div>
                <div class="summary-row">
                    <span>Correo:</span>
                    <span id="display-email">(Por completar)</span>
                </div>
                <div class="summary-row">
                    <span>Distancia estimada:</span>
                    <span id="display-distancia">0 km</span>
                </div>
                <div class="summary-row">
                    <span>Costo total estimado:</span>
                    <span id="display-costo">$0.00 MXN</span>
                </div>
                <div class="summary-row">
                    <span>Depósito requerido (20%):</span>
                    <span id="display-deposito">$0.00 MXN</span>
                </div>
                <div class="summary-row">
                    <span>Pago restante:</span>
                    <span id="display-restante">$0.00 MXN</span>
                </div>
            </div>
            
            <!-- Información de pago -->
            <div class="payment-info">
                <h3>Opciones de Pago</h3>
                <p>Para asegurar su servicio, puede realizar un depósito del 20% del costo total estimado.</p>
                <p>El monto restante se pagará al finalizar el servicio.</p>
                
                <!-- Selección de método de pago -->
                <div class="payment-methods">
                    <div class="payment-method" onclick="selectPaymentMethod('efectivo')">
                        <input type="radio" name="metodo_pago" id="metodo_efectivo" value="efectivo">
                        <img src="https://cdn-icons-png.flaticon.com/512/639/639365.png" alt="Efectivo" class="payment-method-icon">
                        <div class="payment-method-details">
                            <h4 class="payment-method-title">Efectivo</h4>
                            <p class="payment-method-description">Pago en efectivo al momento de recibir el servicio</p>
                        </div>
                    </div>
                    
                    <div class="payment-method" onclick="selectPaymentMethod('paypal')">
                        <input type="radio" name="metodo_pago" id="metodo_paypal" value="paypal">
                        <img src="https://www.paypalobjects.com/webstatic/mktg/logo/pp_cc_mark_37x23.jpg" alt="PayPal" class="payment-method-icon">
                        <div class="payment-method-details">
                            <h4 class="payment-method-title">PayPal</h4>
                            <p class="payment-method-description">Pago seguro con tarjeta de crédito o cuenta PayPal</p>
                        </div>
                    </div>
                </div>
                
                <!-- Contenedor para efectivo -->
                <div id="efectivo-container" class="payment-container">
                    <p>Ha seleccionado pago en efectivo.</p>
                    <p>El monto total de <strong id="efectivo-total">$0.00 MXN</strong> deberá ser pagado al finalizar el servicio.</p>
                    <p><strong>Nota:</strong> Al elegir este método, un operador se pondrá en contacto con usted para confirmar los detalles.</p>
                </div>
                
                <!-- Contenedor del botón de PayPal -->
                <div id="paypal-container" class="payment-container">
                    <div id="paypal-button-container">
                        <button id="custom-paypal-button" class="paypal-button" type="button" onclick="initiatePayPalPayment()">
                            <img src="https://www.paypalobjects.com/webstatic/mktg/logo/pp_cc_mark_37x23.jpg" alt="PayPal Logo">
                            Pagar con PayPal
                        </button>
                    </div>
                </div>
                
                <input type="hidden" id="paypal_order_id" name="paypal_order_id">
                <input type="hidden" id="paypal_status" name="paypal_status">
                <input type="hidden" id="paypal_email" name="paypal_email">
                <input type="hidden" id="paypal_name" name="paypal_name">
                <input type="hidden" id="metodo_pago_seleccionado" name="metodo_pago_seleccionado" value="">
            </div>

            <!-- Checkbox para confirmar consentimiento -->
            <div id="privacy-container" class="privacy-checkbox-container">
                <input type="checkbox" id="consentimiento" name="consentimiento" required>
                <label for="consentimiento"><span class="privacy-text">He leído y acepto la <span class="privacy-link" id="openConsentModal">política de privacidad</span></span></label>
            </div>
            
            <!-- Botones de acción -->
            <div class="action-buttons">
                <button type="submit" class="cta-button" id="submit-button">Enviar Solicitud</button>
            </div>
        </form>
        
        <p class="emergency-note">Para emergencias inmediatas, llame al <a href="tel:+526688253351" class="emergency-phone">668-825-3351</a></p>
    </section>

    <!-- Modal de política de privacidad -->
    <div id="consentModal" class="modal-overlay">
        <div class="modal-container">
            <button class="close-modal" id="closeModal">&times;</button>
            
            <div class="header-decoration">
                <h1>Consentimiento de Datos Personales</h1>
            </div>
            
            <p>Por este medio, expreso y otorgo mi consentimiento a Grúas DBACK en la recopilación, almacenamiento y uso de mis datos personales, con los fines relacionados con la prestación y uso de los servicios prestados por Grúas DBACK, tales como solicitudes de asistencia, el seguimiento de vehículos atendidos y la emisión de recibos o facturas de pago correspondiente.</p>
            
            <h2>Datos personales recopilados</h2>
            <ul>
                <li>Nombre completo</li>
                <li>Domicilio</li>
                <li>Número de teléfono</li>
                <li>Correo electrónico</li>
                <li>Datos del vehículo</li>
                <li>Información de la solicitud de servicio</li>
                <li>Ubicación del servicio</li>
                <li>Fecha y hora de la solicitud</li>
            </ul>
            
            <h2>Tratamiento de datos</h2>
            <p>La información recopilada será tratada en estricto apego a lo establecido por la Ley Federal de Protección de Datos Personales en Posesión de los Particulares y será utilizada exclusivamente para los fines mencionados.</p>
            
            <h2>Medios de contacto de Grúas DBACK para ejercer mis derechos ARCO</h2>
            <p>Para más información sobre los derechos ARCO, visita: <a href="https://www.gob.mx/cms/uploads/attachment/file/428335/DDP_Gu_a_derechos_ARCO_13Dic18.pdf" target="_blank">Guía Derechos ARCO</a></p>
            <p>Correo electrónico: <a href="mailto:protecciondedatos@gruasdback.com">protecciondedatos@gruasdback.com</a></p>
            <p>Teléfono: <a href="tel:6688132905">668 813 2905</a></p>
            <p>Dirección: Manuel Castro Elizalde 895 SUR, Luis Donaldo Colosio, Colón, 81233 Los Mochis, Sin.</p>
            
            <h2>Consentimiento</h2>
            <p>Al hacer clic en "Aceptar", confirmo que he leído y comprendido los términos de esta autorización y que otorgo mi consentimiento para el tratamiento de mis datos personales a Grúas DBACK.</p>
            
            <div class="button-container">
                <a href="#" class="button" id="acceptConsent">Aceptar</a>
                <a href="#" class="button button-reject" id="rejectConsent">Rechazar</a>
            </div>
            
            <div class="footer-decoration">
                <p>Grúas DBACK - Documento de Consentimiento de Datos Personales</p>
            </div>
        </div>
    </div>
    
    <!-- Modal de notificación de rechazo -->
    <div id="rejectModal" class="modal-overlay">
        <div class="small-modal-container">
            <h2>Consentimiento Requerido</h2>
            <p>Debe aceptar la política de privacidad para utilizar nuestros servicios. 
                No podemos procesar su solicitud sin su consentimiento para el tratamiento de datos personales.</p>
            <button class="notification-button" id="closeRejectModal">Entendido</button>
        </div>
    </div>
    
    <!-- Modal de éxito al enviar -->
    <div id="successModal" class="success-modal-overlay">
        <div class="success-modal-container">
            <h2>¡Solicitud Enviada!</h2>
            <p>Su solicitud se ha enviado con éxito.</p>
            <p>Nos pondremos en contacto con usted a la brevedad posible.</p>
            <button class="success-button" id="closeSuccessModal">Aceptar</button>
        </div>
    </div>

    <script>
        // Variables globales
        let costoTotalServicio = 0;
        let paypalButtonsInitialized = false;
        
        // Función para obtener la ubicación actual
        function obtenerUbicacionActual(destino = false) {
            const inputId = destino ? 'ubicacion_destino' : 'ubicacion_origen';
            const ubicacionInput = document.getElementById(inputId);
            
            if (!navigator.geolocation) {
                alert("La geolocalización no es soportada por tu navegador");
                return;
            }
            
            ubicacionInput.placeholder = "Obteniendo ubicación...";
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const coordenadas = `${lat},${lng}`;
                    
                    // Simulamos la obtención de dirección
                    ubicacionInput.value = coordenadas;
                    
                    // Calcular distancia si ambas ubicaciones están completas
                    if (document.getElementById('ubicacion_origen').value && 
                        document.getElementById('ubicacion_destino').value) {
                        calcularDistancia();
                    }
                },
                function(error) {
                    console.error("Error al obtener la ubicación:", error);
                    ubicacionInput.placeholder = "Dirección o punto de referencia";
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            alert("Permiso denegado para acceder a la ubicación");
                            break;
                        case error.POSITION_UNAVAILABLE:
                            alert("La información de ubicación no está disponible");
                            break;
                        case error.TIMEOUT:
                            alert("Tiempo de espera agotado al obtener la ubicación");
                            break;
                        default:
                            alert("Error desconocido al obtener la ubicación");
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Función para actualizar la información del usuario
        function actualizarInfoUsuario() {
            const nombre = document.getElementById('nombre').value || '(Por completar)';
            const email = document.getElementById('email').value || '(No especificado)';
            
            document.getElementById('display-nombre').textContent = nombre;
            document.getElementById('display-email').textContent = email;
            
            // Actualizar campos ocultos para el backend
            document.getElementById('paypal_name').value = nombre;
            document.getElementById('paypal_email').value = email;
        }

        // Función para actualizar la información de pago
        function actualizarInfoPago() {
            const distancia = document.getElementById('distancia').value;
            const deposito = (costoTotalServicio * 0.2).toFixed(2);
            const restante = (costoTotalServicio * 0.8).toFixed(2);
            
            document.getElementById('display-distancia').textContent = distancia;
            document.getElementById('display-costo').textContent = `${costoTotalServicio.toFixed(2)} MXN`;
            document.getElementById('display-deposito').textContent = `${deposito} MXN`;
            document.getElementById('display-restante').textContent = `${restante} MXN`;
            
            // Actualizar también el monto en efectivo
            document.getElementById('efectivo-total').textContent = `$${costoTotalServicio.toFixed(2)} MXN`;
        }

        // Función para calcular la distancia (simulada)
        function calcularDistancia() {
            const origen = document.getElementById('ubicacion_origen').value;
            const destino = document.getElementById('ubicacion_destino').value;
            
            if (!origen || !destino) {
                return; // No calcular si falta alguna ubicación
            }
            
            // Mostrar mensaje de cálculo
            document.getElementById('distancia').value = "Calculando...";
            document.getElementById('costo').value = "Calculando...";
            
            // En una implementación real, usarías la API de Google Maps
            // Esta es una simulación para el ejemplo
            setTimeout(() => {
                const distanciaKm = Math.random() * 50 + 5; // Entre 5 y 55 km
                const costoPorKilometro = 80; // 80 pesos por kilómetro
                costoTotalServicio = distanciaKm * costoPorKilometro;
                
                // Mostrar la distancia y el costo
                document.getElementById('distancia').value = `${distanciaKm.toFixed(2)} km`;
                document.getElementById('costo').value = `${costoTotalServicio.toFixed(2)} MXN`;
                
                // Actualizar la sección de pago
                actualizarInfoPago();
                
                // También actualizamos la información del usuario
                actualizarInfoUsuario();
            }, 1000);
        }

        // Función para seleccionar método de pago
        function selectPaymentMethod(method) {
            // Actualizar radio buttons
            document.getElementById('metodo_efectivo').checked = (method === 'efectivo');
            document.getElementById('metodo_paypal').checked = (method === 'paypal');
            
            // Actualizar clases CSS de los contenedores de métodos
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Seleccionar el método elegido
            if (method === 'efectivo') {
                document.querySelector('.payment-method:nth-child(1)').classList.add('selected');
            } else if (method === 'paypal') {
                document.querySelector('.payment-method:nth-child(2)').classList.add('selected');
            }
            
            // Mostrar el contenedor correspondiente
            document.querySelectorAll('.payment-container').forEach(el => {
                el.classList.remove('active');
            });
            
            document.getElementById(`${method}-container`).classList.add('active');
            
            // Guardar el método seleccionado en el campo oculto
            document.getElementById('metodo_pago_seleccionado').value = method;
        }

        // Función para cargar el SDK de PayPal
        function loadPayPalScript() {
            // Verificar si el script ya está cargado
            if (paypalButtonsInitialized) {
                return;
            }
            
            // Mostrar mensaje de carga
            document.getElementById('paypal-button-container').innerHTML = '<p>Cargando opciones de pago...</p>';
            
            // Cargar el SDK de PayPal
            const script = document.createElement('script');
            // IMPORTANTE: Reemplaza con tu Client ID real de PayPal
            script.src = 'https://www.paypal.com/sdk/js?client-id=AQtRyS9WsZAGYVSbDj_acQ426CavpCZTucraVmHBgae8R9nHwz6HGigDPOgPYRZNxSIJdJLCY0y9FtHT&currency=MXN';
            script.async = true;
            
            script.onerror = function() {
                document.getElementById('paypal-button-container').innerHTML = `
                    <div class="paypal-error">
                        <h4>Error al cargar PayPal</h4>
                        <p>No se pudo cargar el sistema de pagos. Por favor, recargue la página.</p>
                    </div>
                `;
            };
            
            script.onload = function() {
                setupPayPalButtons();
                paypalButtonsInitialized = true;
            };
            
            document.body.appendChild(script);
        }
        
        // Configurar los botones de PayPal
        function setupPayPalButtons() {
            // Limpiar el contenedor
            const buttonContainer = document.getElementById('paypal-button-container');
            buttonContainer.innerHTML = '';
            
            // Calcular el depósito (20% del costo total)
            const deposito = (costoTotalServicio * 0.2).toFixed(2);
            
            if (typeof paypal !== 'undefined') {
                paypal.Buttons({
                    style: {
                        color: 'blue',
                        shape: 'rect',
                        label: 'pay',
                        height: 40
                    },
                    
                    // Crear la orden
                    createOrder: function(data, actions) {
                        return actions.order.create({
                            purchase_units: [{
                                description: 'Depósito para servicio de grúa',
                                amount: {
                                    value: deposito,
                                    currency_code: 'MXN'
                                }
                            }],
                            application_context: {
                                shipping_preference: 'NO_SHIPPING'
                            }
                        });
                    },
                    
                    // Finalizar la transacción
                    onApprove: function(data, actions) {
                        return actions.order.capture().then(function(orderData) {
                            // Procesar la transacción completada
                            const transaction = orderData.purchase_units[0].payments.captures[0];
                            
                            // Actualizar campos ocultos del formulario
                            document.getElementById('paypal_order_id').value = data.orderID;
                            document.getElementById('paypal_status').value = transaction.status;
                            document.getElementById('paypal_email').value = orderData.payer.email_address;
                            document.getElementById('paypal_name').value = orderData.payer.name.given_name + ' ' + (orderData.payer.name.surname || '');
                            
                            // Mostrar mensaje de éxito
                            buttonContainer.innerHTML = `
                                <div class="paypal-success">
                                    <h4>¡Pago completado con éxito!</h4>
                                    <p>ID de transacción: ${data.orderID}</p>
                                    <p>Monto: $${deposito} MXN</p>
                                    <p>Estado: ${transaction.status}</p>
                                </div>
                            `;
                            
                            // Habilitar el botón de enviar formulario
                            document.getElementById('submit-button').disabled = false;
                        });
                    },
                    
                    // Manejar errores
                    onError: function(err) {
                        buttonContainer.innerHTML = `
                            <div class="paypal-error">
                                <h4>Error en el pago</h4>
                                <p>${err.message || 'Ocurrió un error al procesar el pago'}</p>
                                <p>Por favor, intente nuevamente.</p>
                            </div>
                        `;
                    }
                }).render('#paypal-button-container');
            } else {
                buttonContainer.innerHTML = `
                    <div class="paypal-error">
                        <h4>PayPal no disponible</h4>
                        <p>No se pudo cargar el sistema de pagos de PayPal.</p>
                    </div>
                `;
            }
        }

        // Función para iniciar el pago con PayPal
        function initiatePayPalPayment() {
            // Verificar que hay un costo calculado
            if (costoTotalServicio <= 0) {
                alert('Por favor complete la información del servicio para calcular el costo antes de pagar.');
                return;
            }
            
            // Cargar el SDK de PayPal si no está cargado
            loadPayPalScript();
        }

        // Función para validar y enviar el formulario
        function validarYEnviarFormulario(event) {
            event.preventDefault();
            
            // Verificar consentimiento
            if (!document.getElementById('consentimiento').checked) {
                document.getElementById('rejectModal').style.display = 'flex';
                return false;
            }
            
            // Verificar método de pago seleccionado
            const metodoPago = document.getElementById('metodo_pago_seleccionado').value;
            if (!metodoPago) {
                alert('Por favor seleccione un método de pago');
                return false;
            }
            
            // Si es PayPal, verificar que el pago se completó
            if (metodoPago === 'paypal' && !document.getElementById('paypal_order_id').value) {
                alert('Por favor complete el pago con PayPal antes de enviar el formulario');
                return false;
            }
            
            // Mostrar modal de éxito
            document.getElementById('successModal').style.display = 'flex';
            
            // Enviar el formulario después de 2 segundos (simulación)
            setTimeout(() => {
                document.getElementById('servicioForm').submit();
            }, 2000);
            
            return true;
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Botones de ubicación
            document.getElementById('obtenerUbicacionOrigen').addEventListener('click', function() {
                obtenerUbicacionActual(false); // Origen
            });
            
            document.getElementById('obtenerUbicacionDestino').addEventListener('click', function() {
                obtenerUbicacionActual(true); // Destino
            });
            
            // Calcular distancia cuando cambian las ubicaciones
            document.getElementById('ubicacion_origen').addEventListener('change', calcularDistancia);
            document.getElementById('ubicacion_destino').addEventListener('change', calcularDistancia);
            
            // Actualizar información cuando cambian los campos
            document.getElementById('nombre').addEventListener('input', actualizarInfoUsuario);
            document.getElementById('email').addEventListener('input', actualizarInfoUsuario);
            
            // Modal de consentimiento
            document.getElementById('openConsentModal').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('consentModal').style.display = 'flex';
            });
            
            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('consentModal').style.display = 'none';
            });
            
            document.getElementById('acceptConsent').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('consentimiento').checked = true;
                document.getElementById('consentModal').style.display = 'none';
            });
            
            document.getElementById('rejectConsent').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('consentimiento').checked = false;
                document.getElementById('consentModal').style.display = 'none';
                document.getElementById('rejectModal').style.display = 'flex';
            });
            
            // Modal de rechazo
            document.getElementById('closeRejectModal').addEventListener('click', function() {
                document.getElementById('rejectModal').style.display = 'none';
            });
            
            // Modal de éxito
            document.getElementById('closeSuccessModal').addEventListener('click', function() {
                document.getElementById('successModal').style.display = 'none';
            });
            
            // Cerrar modales al hacer clic fuera
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
            
            // Selección de método de pago por defecto
            selectPaymentMethod('efectivo');
        });
    </script>
</body>
</html>